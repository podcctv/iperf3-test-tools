---
trigger: always_on
---

Terminal Autopilot Rules (PowerShell)

==================================================
0) Scope
==================================================
- This ruleset is for PowerShell terminals on Windows.
- Goal:
  - maximize safe auto-execution
  - minimize manual approvals
  - allow controlled automatic git commits
  - enforce post-deployment validation (docker + database)

==================================================
1) Execution Discipline (MANDATORY)
==================================================
1. Execute EXACTLY ONE terminal command per execution request.
2. DO NOT chain commands using ; && or || .
3. DO NOT use pipelines | unless explicitly requested by the user.
4. DO NOT use redirections:
   - 2>&1
   - *>
   - Out-File
   - Tee-Object
   unless explicitly requested.
5. DO NOT wrap commands using:
   - powershell -Command
   - scriptblocks { }
   - Invoke-Expression
   - cmd /c
6. If waiting is needed, run Start-Sleep as a standalone command only.

Reason:
Chaining, redirection, and scripting patterns often trigger manual approval
even if individual commands are allow-listed.

==================================================
2) Allowed Auto-Execution (Safe Command Families)
==================================================

The agent SHOULD auto-execute these commands when they match the allow list
and remain standalone.

--------------------
Docker / Docker Compose (safe subset)
--------------------
- docker compose ps
- docker compose pull
- docker compose build
- docker compose up
- docker compose up -d
- docker compose logs --tail <N> <service>
- docker logs --tail <N> <container>
- docker ps
- docker inspect <container>

--------------------
Git (auto-commit enabled, controlled)
--------------------
Read / sync:
- git status
- git log
- git diff
- git fetch
- git pull
- git branch
- git show

Write (controlled auto-execution):
- git add <path>
- git add .
- git commit -m "<message>"

Restrictions:
- Commit message MUST be provided explicitly.
- Commit message MUST be a single line.
- Commit message MUST describe WHAT and WHY (no placeholders).

--------------------
Wait
--------------------
- Start-Sleep -Seconds <N>

==================================================
3) Git Auto-Commit Rules (CRITICAL)
==================================================

Automatic git commits are allowed ONLY under the following conditions:

1. The agent has already shown:
   - git status
   - git diff (or equivalent explanation of changes)

2. The commit message is:
   - Explicitly provided by the user OR
   - Generated by the agent AND shown to the user before commit

3. The commit message:
   - Is a single line
   - Does NOT contain "WIP", "temp", "test", or empty placeholders

4. The agent MUST execute git commands in this exact order:
   1) git status
   2) git add <path> OR git add .
   3) git commit -m "<message>"

5. The agent MUST NOT:
   - squash commits
   - amend commits
   - rewrite history

==================================================
4) Docker Deploy: Mandatory Post-Checks
==================================================

After ANY of the following actions:
- docker compose up
- docker compose up -d
- docker compose pull
- docker compose build
- docker compose restart <service> (only when explicitly requested or after approved DB migration)

The agent MUST run the validation sequence below.

--------------------
Step A: Check container / service state
--------------------
Run:
- docker compose ps

Interpretation:
- If all services are running (or healthy), proceed to Step C.
- If any service is exited, restarting, or unhealthy, go to Step B.

--------------------
Step B: Inspect logs
--------------------
For each failing or suspicious service/container, run ONE of:
- docker compose logs --tail 80 <service_name>
- docker logs --tail 80 <container_name_or_id>

--------------------
Step C: Classify startup result
--------------------
If logs contain ANY of the following, treat startup as FAILED:

- ERROR / Error / error
- FATAL
- panic
- exception
- Traceback
- permission denied
- address already in use
- bind:
- cannot
- failed
- exited
- restarting
- CrashLoop

On FAILED startup:
1. Stop further automation immediately.
2. Quote only the minimal relevant error lines.
3. Suggest the smallest next diagnostic step (read-only first).
4. DO NOT run destructive or recovery commands automatically.

On OK startup:
- Report that deployment looks healthy.

==================================================
5) Database Migration Handling (Controlled + Verifiable)
==================================================

Migration rules remain UNCHANGED:
- Schema inspection: auto
- ALTER / CREATE / DROP: manual approval
- Post-migration restart + log check: mandatory

==================================================
6) Forbidden Without Explicit Instruction (High Risk)
==================================================

Docker:
- docker exec (except read-only schema inspection)
- docker compose down
- docker compose rm
- docker rm
- docker system prune
- any volume or image deletion

Git:
- git push
- git push --force
- git reset
- git reset --hard
- git clean
- git commit --amend
- any history-rewriting operation

Shell:
- powershell -Command
- Invoke-Expression
- cmd /c

==================================================
7) Error Handling Policy
==================================================
- On any command failure: stop and explain clearly.
- Prefer read-only diagnostics before modifications.
- Never retry destructive commands automatically.
- Keep commands atomic to maximize allow-list auto-execution.

==================================================
8) Practical PowerShell Execution Templates
==================================================

Git auto-commit (example flow):
1) git status
2) git diff
3) git add .
4) git commit -m "Add udp_bandwidth column handling and migration notes"

Deploy then validate:
1) docker compose up -d
2) docker compose ps
3) docker logs --tail 80 <service_or_container>

End of ruleset.
